<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.inbody.crm.im.dao.ImInvoiceDtlDao">
    
	
	<!-- 发票查询画面，发票list分页查询 -->
	<select id="findPageList" resultType="ImInvoiceSearch">
		SELECT
				rest.INVOICE_SOURCE AS 'invoiceSource',
				rest.ORDER_NO AS 'orderNo',
				rest.LINE_NO AS 'lineNo',
				rest.CUSTOMER_NAME AS 'customerName',
				rest.EMPLOYEE_NAME AS 'employeeName',
				rest.RESPONSIBLE_PERSON_NAME AS 'responsiblePersonName',
				rest.MATERIAL_NAME AS 'materialName',
				rest.COMMISSION_PEISON_NAME AS 'commissionPeison',
				rest.ORGANIZE_NAME AS 'organize',
				rest.INVOICE_TYPE AS 'invoiceType',
				rest.NUM AS 'num',
				rest.UNIT_PRICE AS 'unitPrice',
				rest.INVOICE_AMOUNT AS 'invoiceAmount',
				rest.TAX AS 'tax',
				rest.INVOICE_DATE AS 'invoiceDate',
				rest.INVOICE_NO AS 'invoiceNo',
				rest.INVOICE_TITLE AS 'invoiceTitle',
				rest.TICKET_METHOD AS 'ticketMethod',
				rest.RECIPIENTS AS 'recipients',
				rest.REP_TELEPHONE AS 'repTelephone',
				rest.ADDRESS AS 'address',
				rest.EXPRESS_NO AS 'expressNo',
				rest.EXPRESS_COMPANY AS 'expressCompany'
		FROM (
	    <if test="invoiceSource == null or invoiceSource == '' or invoiceSource == '10'">
		(SELECT
				'10' AS INVOICE_SOURCE,
				soTemp.ORDER_NO AS ORDER_NO,
				soTemp.LINE_NO AS LINE_NO,
				soTemp.CUSTOMER_NAME AS CUSTOMER_NAME,
				soTemp.EMPLOYEE_NAME AS EMPLOYEE_NAME,
				soTemp.RESPONSIBLE_PERSON_NAME AS RESPONSIBLE_PERSON_NAME,
				soTemp.MATERIAL_NAME AS MATERIAL_NAME,
				soTemp.COMMISSION_PEISON_NAME AS COMMISSION_PEISON_NAME,
				soTemp.ORGANIZE_NAME AS ORGANIZE_NAME,
				soTemp.NUM AS NUM,
				soTemp.UNIT_PRICE AS UNIT_PRICE,
				imTemp.INVOICE_TYPE AS INVOICE_TYPE,
				imTemp.INVOICE_AMOUNT AS INVOICE_AMOUNT,
				imTemp.TAX AS TAX,
				imTemp.INVOICE_DATE AS INVOICE_DATE,
				imTemp.INVOICE_NO AS INVOICE_NO,
				imTemp.INVOICE_TITLE AS INVOICE_TITLE,
				imTemp.TICKET_METHOD AS TICKET_METHOD,
				imTemp.RECIPIENTS AS RECIPIENTS,
				imTemp.REP_TELEPHONE AS REP_TELEPHONE,
				imTemp.ADDRESS AS ADDRESS,
				imTemp.EXPRESS_NO AS EXPRESS_NO,
				imTemp.EXPRESS_COMPANY AS EXPRESS_COMPANY
		FROM 
		(SELECT
				so.ORDER_NO AS ORDER_NO,
				sod.LINE_NO AS LINE_NO,
				MAX(so.EMPLOYEE_NO) AS EMPLOYEE_NO,
				MAX(su.NAME) AS EMPLOYEE_NAME,
				MAX(so.CUSTOMER_ID) AS CUSTOMER_ID,
				MAX(so.CUSTOMER_CH_NAME) AS CUSTOMER_NAME,
				MAX(sod.COMMISSION_PEISON_ID) AS COMMISSION_PEISON_ID,
				MAX(tmsu.NAME) AS RESPONSIBLE_PERSON_NAME,
				MAX(tsu.NAME) AS COMMISSION_PEISON_NAME,
				MAX(sod.ORGANIZE) AS ORGANIZE,
				MAX(sof.NAME) AS ORGANIZE_NAME,
				MAX(sod.MATERIAL_NO) AS MATERIAL_NO,
				MAX(CONCAT(smi.MATERIAL_NAME,smi.MODEL)) AS MATERIAL_NAME,
				MAX(sod.NUM) AS NUM,
				MAX(sod.UNIT_PRICE) AS UNIT_PRICE
		FROM SO_ORDER so
		INNER JOIN SO_ORDER_DTL sod ON sod.ORDER_ID = so.ID
		LEFT JOIN SYS_USER su ON su.ID = so.EMPLOYEE_NO
		LEFT JOIN SYS_USER tsu ON tsu.ID = sod.COMMISSION_PEISON_ID
		LEFT JOIN SYS_USER tmsu ON tmsu.ID = sod.RESPONSIBLE_PERSON_ID
		LEFT JOIN SM_MAT_INFO smi ON smi.MATERIAL_NO = sod.MATERIAL_NO
		LEFT JOIN SYS_OFFICE sof ON sof.ID = sod.ORGANIZE
		WHERE
			 so.del_flag = '0'
			<if test="orderNo != null and orderNo != ''">
				AND so.order_no like CONCAT(CONCAT('%', #{orderNo}), '%')
			</if>
			<if test="commissionPeison != null and commissionPeison != ''">
				AND sod.COMMISSION_PEISON_ID = #{commissionPeison}
			</if>
			<if test="organize != null and organize != ''">
				AND sod.ORGANIZE = #{organize}
			</if>
			<if test="sqlMap != null and sqlMap.dataScope != null">
				AND so.EMPLOYEE_NO in ${sqlMap.dataScope}
			</if>
		GROUP BY so.ORDER_NO, sod.LINE_NO
		) soTemp
		INNER JOIN 
		(SELECT
				iid.ORDER_NO AS ORDER_NO,
				iid.LINE_NO AS LINE_NO,
				iid.INVOICE_TYPE AS INVOICE_TYPE,
				iid.INVOICE_AMOUNT AS INVOICE_AMOUNT,
				iid.TAX AS TAX,
				iid.INVOICE_DATE AS INVOICE_DATE,
				iid.INVOICE_NO AS INVOICE_NO,
				iid.EXPRESS_NO AS EXPRESS_NO,
				iid.EXPRESS_COMPANY AS EXPRESS_COMPANY,
				ii.INVOICE_TITLE AS INVOICE_TITLE,
				ii.TICKET_METHOD AS TICKET_METHOD,
				ii.RECIPIENTS AS RECIPIENTS,
				ii.REP_TELEPHONE AS REP_TELEPHONE,
				ii.ADDRESS AS ADDRESS
		FROM IM_INVOICE ii
		INNER JOIN IM_INVOICE_DTL iid ON ii.id = iid.APP_ID
		WHERE
			iid.invoice_source = '10' 
			AND ii.WORKFLOW_STATUS = '50' 
			AND ii.del_flag = '0'
			<if test="invoiceType != null and invoiceType != ''">
				AND iid.invoice_type = #{invoiceType}
			</if>
			<if test="invoiceNo != null and invoiceNo != ''">
				AND iid.invoice_no like CONCAT(CONCAT('%', #{invoiceNo}), '%')
			</if>
			<if test="invoiceTitle != null and invoiceTitle != ''">
				AND ii.invoice_title like CONCAT(CONCAT('%', #{invoiceTitle}), '%')
			</if>
			<if test="invoiceDateBegin != null and invoiceDateBegin != ''">
				AND iid.invoice_date >= #{invoiceDateBegin}
			</if>
			<if test="invoiceDateEnd != null and invoiceDateEnd != ''">
				AND #{invoiceDateEnd} >= iid.invoice_date
			</if>
		) imTemp ON imTemp.order_no = soTemp.order_no AND imTemp.LINE_NO = soTemp.LINE_NO)
		</if>
		<if test="invoiceSource == null or invoiceSource == ''">
		UNION ALL
		</if>
		<if test="invoiceSource == null or invoiceSource == '' or invoiceSource == '20'">
		(SELECT
				'20' AS INVOICE_SOURCE,
				rqTemp.ORDER_NO AS ORDER_NO,
				rqTemp.LINE_NO AS LINE_NO,
				rqTemp.CUSTOMER_NAME AS CUSTOMER_NAME,
				rqTemp.EMPLOYEE_NAME AS EMPLOYEE_NAME,
				'' AS RESPONSIBLE_PERSON_NAME,
				rqTemp.MATERIAL_NAME AS MATERIAL_NAME,
				'' AS COMMISSION_PEISON_NAME,
				rqTemp.ORGANIZE_NAME AS ORGANIZE_NAME,
				rqTemp.NUM AS NUM,
				rqTemp.UNIT_PRICE AS UNIT_PRICE,
				rqImTemp.INVOICE_TYPE AS INVOICE_TYPE,
				rqImTemp.INVOICE_AMOUNT AS INVOICE_AMOUNT,
				rqImTemp.TAX AS TAX,
				rqImTemp.INVOICE_DATE AS INVOICE_DATE,
				rqImTemp.INVOICE_NO AS INVOICE_NO,
				rqImTemp.INVOICE_TITLE AS INVOICE_TITLE,
				rqImTemp.TICKET_METHOD AS TICKET_METHOD,
				rqImTemp.RECIPIENTS AS RECIPIENTS,
				rqImTemp.REP_TELEPHONE AS REP_TELEPHONE,
				rqImTemp.ADDRESS AS ADDRESS,
				rqImTemp.EXPRESS_NO AS EXPRESS_NO,
				rqImTemp.EXPRESS_COMPANY AS EXPRESS_COMPANY
		FROM
		(SELECT
				rq.quotation_no AS ORDER_NO,
				rqd.LINE_NO AS LINE_NO,
				MAX(rq.RESPONSIBLE_PERSON_ID) AS EMPLOYEE_NO,
				MAX(su.NAME) AS EMPLOYEE_NAME,
				MAX(rq.CUSTOMER_ID) AS CUSTOMER_ID,
				MAX(cci.CUSTOMER_CH_NAME) AS CUSTOMER_NAME,
				MAX(rq.ORGANIZE) AS ORGANIZE,
				MAX(sof.NAME) AS ORGANIZE_NAME,
				MAX(rqd.MATERIAL_NO) AS MATERIAL_NO,
				MAX(CONCAT(smi.MATERIAL_NAME,smi.MODEL)) AS MATERIAL_NAME,
				MAX(rqd.NUM) AS NUM,
				MAX(rqd.UNIT_PRICE) AS UNIT_PRICE
		FROM RM_QUOTATION rq 
		INNER JOIN RM_QUOTATION_DTL rqd ON rqd.REPAIR_NO = rq.REPAIR_NO AND rqd.quotation_no = rq.quotation_no
		LEFT JOIN SYS_USER su ON su.ID = rq.RESPONSIBLE_PERSON_ID
		LEFT JOIN CM_CUSTOMER_INFO cci ON cci.CUSTOMER_ID = rq.CUSTOMER_ID
		LEFT JOIN SM_MAT_INFO smi ON smi.MATERIAL_NO = rqd.MATERIAL_NO
		LEFT JOIN SYS_OFFICE sof ON sof.ID = rq.ORGANIZE
		WHERE
			 rq.del_flag = '0'
			 AND rq.QUOTATION_TYPE = '2'
			<if test="orderNo != null and orderNo != ''">
				AND rq.quotation_no like CONCAT(CONCAT('%', #{orderNo}), '%')
			</if>
			<if test="commissionPeison != null and commissionPeison != ''">
				AND rq.RESPONSIBLE_PERSON_ID = #{commissionPeison}
			</if>
			<if test="organize != null and organize != ''">
				AND rq.ORGANIZE = #{organize}
			</if>
			<if test="sqlMap != null and sqlMap.dataScope != null">
				AND rq.RESPONSIBLE_PERSON_ID in ${sqlMap.dataScope}
			</if>
		GROUP BY rq.quotation_no, rqd.LINE_NO
		) rqTemp
		INNER JOIN 
		(SELECT
				iid.ORDER_NO AS ORDER_NO,
				iid.LINE_NO AS LINE_NO,
				iid.INVOICE_TYPE AS INVOICE_TYPE,
				iid.INVOICE_AMOUNT AS INVOICE_AMOUNT,
				iid.TAX AS TAX,
				iid.INVOICE_DATE AS INVOICE_DATE,
				iid.INVOICE_NO AS INVOICE_NO,
				iid.EXPRESS_NO AS EXPRESS_NO,
				iid.EXPRESS_COMPANY AS EXPRESS_COMPANY,
				ii.INVOICE_TITLE AS INVOICE_TITLE,
				ii.TICKET_METHOD AS TICKET_METHOD,
				ii.RECIPIENTS AS RECIPIENTS,
				ii.REP_TELEPHONE AS REP_TELEPHONE,
				ii.ADDRESS AS ADDRESS
		FROM IM_INVOICE ii
		INNER JOIN IM_INVOICE_DTL iid ON ii.id = iid.APP_ID
		WHERE
			iid.invoice_source = '20' 
			AND ii.WORKFLOW_STATUS = '50' 
			AND ii.del_flag = '0'
			<if test="invoiceType != null and invoiceType != ''">
				AND iid.invoice_type = #{invoiceType}
			</if>
			<if test="invoiceNo != null and invoiceNo != ''">
				AND iid.invoice_no like CONCAT(CONCAT('%', #{invoiceNo}), '%')
			</if>
			<if test="invoiceTitle != null and invoiceTitle != ''">
				AND ii.invoice_title like CONCAT(CONCAT('%', #{invoiceTitle}), '%')
			</if>
			<if test="invoiceDateBegin != null and invoiceDateBegin != ''">
				AND iid.invoice_date >= #{invoiceDateBegin}
			</if>
			<if test="invoiceDateEnd != null and invoiceDateEnd != ''">
				AND #{invoiceDateEnd} >= iid.invoice_date
			</if>
		) rqImTemp ON rqImTemp.order_no = rqTemp.order_no AND rqImTemp.LINE_NO = rqTemp.LINE_NO)
		</if>
		) rest
		<where>
			<if test="materialName != null and materialName != ''">
				AND rest.MATERIAL_NAME like CONCAT(CONCAT('%', #{materialName}), '%')
			</if>
		</where>
		ORDER BY rest.INVOICE_DATE DESC, rest.ORDER_NO DESC, rest.LINE_NO
	</select>
	<!-- <select id="findPageList" resultType="ImInvoiceSearch">
		SELECT
				rest.INVOICE_SOURCE AS 'invoiceSource',
				rest.ORDER_NO AS 'orderNo',
				rest.CUSTOMER_NAME AS 'customerName',
				rest.EMPLOYEE_NAME AS 'employeeName',
				rest.RESPONSIBLE_PERSON_NAME AS 'responsiblePersonName',
				rest.MATERIAL_NAME AS 'materialName',
				rest.COMMISSION_PEISON_NAME AS 'commissionPeison',
				rest.LINE_NO AS 'lineNo',
				rest.ORGANIZE_NAME AS 'organize',
				rest.INVOICE_TYPE AS 'invoiceType',
				rest.NUM AS 'num',
				rest.UNIT_PRICE AS 'unitPrice',
				rest.INVOICE_AMOUNT AS 'invoiceAmount',
				rest.TAX AS 'tax',
				rest.INVOICE_DATE AS 'invoiceDate',
				rest.INVOICE_NO AS 'invoiceNo',
				rest.INVOICE_TITLE AS 'invoiceTitle',
				rest.TICKET_METHOD AS 'ticketMethod',
				rest.RECIPIENTS AS 'recipients',
				rest.REP_TELEPHONE AS 'repTelephone',
				rest.ADDRESS AS 'address',
				rest.EXPRESS_NO AS 'expressNo',
				rest.EXPRESS_COMPANY AS 'expressCompany'
		FROM (
	    <if test="invoiceSource == null or invoiceSource == '' or invoiceSource == '10'">
		(SELECT
				iid.INVOICE_SOURCE AS INVOICE_SOURCE,
				iid.ORDER_NO AS ORDER_NO,
				temp.CUSTOMER_NAME AS CUSTOMER_NAME,
				temp.EMPLOYEE_NAME AS EMPLOYEE_NAME,
				temp.RESPONSIBLE_PERSON_NAME AS RESPONSIBLE_PERSON_NAME,
				temp.MATERIAL_NAME AS MATERIAL_NAME,
				temp.COMMISSION_PEISON_NAME AS COMMISSION_PEISON_NAME,
				temp.LINE_NO AS LINE_NO,
				temp.ORGANIZE_NAME AS ORGANIZE_NAME,
				iid.INVOICE_TYPE AS INVOICE_TYPE,
				temp.NUM AS NUM,
				temp.UNIT_PRICE AS UNIT_PRICE,
				iid.INVOICE_AMOUNT AS INVOICE_AMOUNT,
				iid.TAX AS TAX,
				iid.INVOICE_DATE AS INVOICE_DATE,
				iid.INVOICE_NO AS INVOICE_NO,
				ii.INVOICE_TITLE AS INVOICE_TITLE,
				ii.TICKET_METHOD AS TICKET_METHOD,
				ii.RECIPIENTS AS RECIPIENTS,
				ii.REP_TELEPHONE AS REP_TELEPHONE,
				ii.ADDRESS AS ADDRESS,
				iid.EXPRESS_NO AS EXPRESS_NO,
				iid.EXPRESS_COMPANY AS EXPRESS_COMPANY
		FROM IM_INVOICE_DTL iid
		INNER JOIN
		(SELECT
				so.ORDER_NO AS ORDER_NO,
				so.EMPLOYEE_NO AS EMPLOYEE_NO,
				su.NAME AS EMPLOYEE_NAME,
				so.CUSTOMER_ID AS CUSTOMER_ID,
				cci.CUSTOMER_CH_NAME AS CUSTOMER_NAME,
				sod.LINE_NO AS LINE_NO,
				sod.COMMISSION_PEISON_ID AS COMMISSION_PEISON_ID,
				tmsu.NAME AS RESPONSIBLE_PERSON_NAME,
				tsu.NAME AS COMMISSION_PEISON_NAME,
				sod.ORGANIZE AS ORGANIZE,
				sof.NAME AS ORGANIZE_NAME,
				sod.MATERIAL_NO AS MATERIAL_NO,
				CONCAT(smi.MATERIAL_NAME,smi.MODEL) AS MATERIAL_NAME,
				sod.NUM AS NUM,
				sod.UNIT_PRICE AS UNIT_PRICE
		FROM SO_ORDER_DTL sod
		INNER JOIN SO_ORDER so ON sod.ORDER_ID = so.ID AND so.del_flag = '0'
		LEFT JOIN SYS_USER su ON su.ID = so.EMPLOYEE_NO
		LEFT JOIN SYS_USER tsu ON tsu.ID = sod.COMMISSION_PEISON_ID
		LEFT JOIN SYS_USER tmsu ON tmsu.ID = sod.RESPONSIBLE_PERSON_ID
		LEFT JOIN CM_CUSTOMER_INFO cci ON cci.CUSTOMER_ID = so.CUSTOMER_ID
		LEFT JOIN SM_MAT_INFO smi ON smi.MATERIAL_NO = sod.MATERIAL_NO
		LEFT JOIN SYS_OFFICE sof ON sof.ID = sod.ORGANIZE
		) temp
		ON iid.order_no = temp.order_no AND iid.LINE_NO = temp.LINE_NO
		INNER JOIN IM_INVOICE ii
		ON ii.id = iid.APP_ID AND ii.WORKFLOW_STATUS = '50' AND ii.del_flag = '0'
		<where>
			iid.invoice_source = '10'
			<if test="orderNo != null and orderNo != ''">
				AND iid.order_no like CONCAT(CONCAT('%', #{orderNo}), '%')
			</if>
			<if test="invoiceType != null and invoiceType != ''">
				AND iid.invoice_type = #{invoiceType}
			</if>
			<if test="invoiceNo != null and invoiceNo != ''">
				AND iid.invoice_no like CONCAT(CONCAT('%', #{invoiceNo}), '%')
			</if>
			<if test="invoiceTitle != null and invoiceTitle != ''">
				AND ii.invoice_title like CONCAT(CONCAT('%', #{invoiceTitle}), '%')
			</if>
			<if test="invoiceDateBegin != null and invoiceDateBegin != ''">
				AND iid.invoice_date >= #{invoiceDateBegin}
			</if>
			<if test="invoiceDateEnd != null and invoiceDateEnd != ''">
				AND #{invoiceDateEnd} >= iid.invoice_date
			</if>
			<if test="commissionPeison != null and commissionPeison != ''">
				AND temp.COMMISSION_PEISON_ID = #{commissionPeison}
			</if>
			<if test="organize != null and organize != ''">
				AND temp.ORGANIZE = #{organize}
			</if>
			<if test="materialName != null and materialName != ''">
				AND temp.MATERIAL_NAME like CONCAT(CONCAT('%', #{materialName}), '%')
			</if>
			<if test="sqlMap != null and sqlMap.dataScope != null">
				AND temp.EMPLOYEE_NO in ${sqlMap.dataScope}
			</if>
		</where>
		)
		</if>
		<if test="invoiceSource == null or invoiceSource == ''">
		UNION ALL
		</if>
		<if test="invoiceSource == null or invoiceSource == '' or invoiceSource == '20'">
		(SELECT
				iid.INVOICE_SOURCE AS INVOICE_SOURCE,
				iid.ORDER_NO AS ORDER_NO,
				temp.CUSTOMER_NAME AS CUSTOMER_NAME,
				temp.EMPLOYEE_NAME AS EMPLOYEE_NAME,
				'' AS RESPONSIBLE_PERSON_NAME,
				temp.MATERIAL_NAME AS MATERIAL_NAME,
				'' AS COMMISSION_PEISON_NAME,
				temp.LINE_NO AS LINE_NO,
				temp.ORGANIZE_NAME AS ORGANIZE_NAME,
				iid.INVOICE_TYPE AS INVOICE_TYPE,
				temp.NUM AS NUM,
				temp.UNIT_PRICE AS UNIT_PRICE,
				iid.INVOICE_AMOUNT AS INVOICE_AMOUNT,
				iid.TAX AS TAX,
				iid.INVOICE_DATE AS INVOICE_DATE,
				iid.INVOICE_NO AS INVOICE_NO,
				ii.INVOICE_TITLE AS INVOICE_TITLE,
				ii.TICKET_METHOD AS TICKET_METHOD,
				ii.RECIPIENTS AS RECIPIENTS,
				ii.REP_TELEPHONE AS REP_TELEPHONE,
				ii.ADDRESS AS ADDRESS,
				iid.EXPRESS_NO AS EXPRESS_NO,
				iid.EXPRESS_COMPANY AS EXPRESS_COMPANY
		FROM IM_INVOICE_DTL iid
		INNER JOIN
		(SELECT
				rq.quotation_no AS ORDER_NO,
				rq.RESPONSIBLE_PERSON_ID AS EMPLOYEE_NO,
				su.NAME AS EMPLOYEE_NAME,
				rq.CUSTOMER_ID AS CUSTOMER_ID,
				cci.CUSTOMER_CH_NAME AS CUSTOMER_NAME,
				rqd.LINE_NO AS LINE_NO,
				rq.ORGANIZE AS ORGANIZE,
				sof.NAME AS ORGANIZE_NAME,
				rqd.MATERIAL_NO AS MATERIAL_NO,
				CONCAT(smi.MATERIAL_NAME,smi.MODEL) AS MATERIAL_NAME,
				rqd.NUM AS NUM,
				rqd.UNIT_PRICE AS UNIT_PRICE
		FROM RM_QUOTATION_DTL rqd
		INNER JOIN RM_QUOTATION rq ON rqd.REPAIR_NO = rq.REPAIR_NO AND rqd.quotation_no = rq.quotation_no AND rq.del_flag = '0'
		LEFT JOIN SYS_USER su ON su.ID = rq.RESPONSIBLE_PERSON_ID
		LEFT JOIN CM_CUSTOMER_INFO cci ON cci.CUSTOMER_ID = rq.CUSTOMER_ID
		LEFT JOIN SM_MAT_INFO smi ON smi.MATERIAL_NO = rqd.MATERIAL_NO
		LEFT JOIN SYS_OFFICE sof ON sof.ID = rq.ORGANIZE
		) temp
		ON iid.order_no = temp.order_no AND iid.LINE_NO = temp.LINE_NO
		INNER JOIN IM_INVOICE ii
		ON ii.id = iid.APP_ID AND ii.WORKFLOW_STATUS = '50' AND ii.del_flag = '0'
		<where>
			iid.invoice_source = '20'
			<if test="orderNo != null and orderNo != ''">
				AND iid.order_no like CONCAT(CONCAT('%', #{orderNo}), '%')
			</if>
			<if test="invoiceType != null and invoiceType != ''">
				AND iid.invoice_type = #{invoiceType}
			</if>
			<if test="invoiceNo != null and invoiceNo != ''">
				AND iid.invoice_no like CONCAT(CONCAT('%', #{invoiceNo}), '%')
			</if>
			<if test="invoiceTitle != null and invoiceTitle != ''">
				AND ii.invoice_title like CONCAT(CONCAT('%', #{invoiceTitle}), '%')
			</if>
			<if test="invoiceDateBegin != null and invoiceDateBegin != ''">
				AND iid.invoice_date >= #{invoiceDateBegin}
			</if>
			<if test="invoiceDateEnd != null and invoiceDateEnd != ''">
				AND #{invoiceDateEnd} >= iid.invoice_date
			</if>
			<if test="commissionPeison != null and commissionPeison != ''">
				AND temp.EMPLOYEE_NO = #{commissionPeison}
			</if>
			<if test="organize != null and organize != ''">
				AND temp.ORGANIZE = #{organize}
			</if>
			<if test="materialName != null and materialName != ''">
				AND temp.MATERIAL_NAME like CONCAT(CONCAT('%', #{materialName}), '%')
			</if>
			<if test="sqlMap != null and sqlMap.dataScope != null">
				AND temp.EMPLOYEE_NO in ${sqlMap.dataScope}
			</if>
		</where>
		)
		</if>
		) rest
		ORDER BY rest.INVOICE_SOURCE, rest.ORDER_NO, rest.LINE_NO
	</select> -->
	<!-- <select id="findPageList" resultType="ImInvoiceSearch">
	    <if test="invoiceSource == null or invoiceSource == '' or invoiceSource == '10'">
		(SELECT
				iid.invoice_source AS 'invoiceSource',
				iid.order_no AS 'orderNo',
				temp.CUSTOMER_NAME AS 'customerName',
				temp.EMPLOYEE_NAME AS 'employeeName',
				temp.RESPONSIBLE_PERSON_NAME AS 'responsiblePersonName',
				temp.MATERIAL_NAME AS 'materialName',
				temp.COMMISSION_PEISON_NAME AS 'commissionPeison',
				temp.LINE_NO AS 'lineNo',
				temp.ORGANIZE_NAME AS 'organize',
				iid.INVOICE_TYPE AS 'invoiceType',
				temp.NUM AS 'num',
				temp.UNIT_PRICE AS 'unitPrice',
				iid.invoice_amount AS 'invoiceAmount',
				iid.tax AS 'tax',
				iid.invoice_date AS 'invoiceDate',
				iid.invoice_no AS 'invoiceNo',
				ii.invoice_title AS 'invoiceTitle',
				ii.ticket_method AS 'ticketMethod',
				ii.recipients AS 'recipients',
				ii.rep_telephone AS 'repTelephone',
				ii.address AS 'address',
				iid.express_no AS 'expressNo',
				iid.express_company AS 'expressCompany'
		FROM IM_INVOICE_DTL iid
		INNER JOIN
		(SELECT
				so.ORDER_NO AS ORDER_NO,
				so.EMPLOYEE_NO AS EMPLOYEE_NO,
				su.NAME AS EMPLOYEE_NAME,
				so.CUSTOMER_ID AS CUSTOMER_ID,
				cci.CUSTOMER_CH_NAME AS CUSTOMER_NAME,
				sod.LINE_NO AS LINE_NO,
				sod.COMMISSION_PEISON_ID AS COMMISSION_PEISON_ID,
				tmsu.NAME AS RESPONSIBLE_PERSON_NAME,
				tsu.NAME AS COMMISSION_PEISON_NAME,
				sod.ORGANIZE AS ORGANIZE,
				sof.NAME AS ORGANIZE_NAME,
				sod.MATERIAL_NO AS MATERIAL_NO,
				CONCAT(smi.MATERIAL_NAME,smi.MODEL) AS MATERIAL_NAME,
				sod.NUM AS NUM,
				sod.UNIT_PRICE AS UNIT_PRICE
		FROM SO_ORDER_DTL sod
		INNER JOIN SO_ORDER so ON sod.ORDER_ID = so.ID AND so.del_flag = '0'
		LEFT JOIN SYS_USER su ON su.ID = so.EMPLOYEE_NO
		LEFT JOIN SYS_USER tsu ON tsu.ID = sod.COMMISSION_PEISON_ID
		LEFT JOIN SYS_USER tmsu ON tmsu.ID = sod.RESPONSIBLE_PERSON_ID
		LEFT JOIN CM_CUSTOMER_INFO cci ON cci.CUSTOMER_ID = so.CUSTOMER_ID
		LEFT JOIN SM_MAT_INFO smi ON smi.MATERIAL_NO = sod.MATERIAL_NO
		LEFT JOIN SYS_OFFICE sof ON sof.ID = sod.ORGANIZE
		) temp
		ON iid.order_no = temp.order_no AND iid.LINE_NO = temp.LINE_NO
		INNER JOIN IM_INVOICE ii
		ON ii.id = iid.APP_ID AND ii.WORKFLOW_STATUS = '50' AND ii.del_flag = '0'
		<where>
			iid.invoice_source = '10'
			<if test="orderNo != null and orderNo != ''">
				AND iid.order_no like CONCAT(CONCAT('%', #{orderNo}), '%')
			</if>
			<if test="invoiceType != null and invoiceType != ''">
				AND iid.invoice_type = #{invoiceType}
			</if>
			<if test="invoiceNo != null and invoiceNo != ''">
				AND iid.invoice_no like CONCAT(CONCAT('%', #{invoiceNo}), '%')
			</if>
			<if test="invoiceTitle != null and invoiceTitle != ''">
				AND ii.invoice_title like CONCAT(CONCAT('%', #{invoiceTitle}), '%')
			</if>
			<if test="invoiceDateBegin != null and invoiceDateBegin != ''">
				AND iid.invoice_date >= #{invoiceDateBegin}
			</if>
			<if test="invoiceDateEnd != null and invoiceDateEnd != ''">
				AND #{invoiceDateEnd} >= iid.invoice_date
			</if>
			<if test="commissionPeison != null and commissionPeison != ''">
				AND temp.COMMISSION_PEISON_ID = #{commissionPeison}
			</if>
			<if test="organize != null and organize != ''">
				AND temp.ORGANIZE = #{organize}
			</if>
			<if test="materialName != null and materialName != ''">
				AND temp.MATERIAL_NAME like CONCAT(CONCAT('%', #{materialName}), '%')
			</if>
			<if test="sqlMap != null and sqlMap.dataScope != null">
				AND temp.EMPLOYEE_NO in ${sqlMap.dataScope}
			</if>
		</where>
		)
		</if>
		<if test="invoiceSource == null or invoiceSource == ''">
		UNION ALL
		</if>
		<if test="invoiceSource == null or invoiceSource == '' or invoiceSource == '20'">
		(SELECT
				iid.invoice_source AS 'invoiceSource',
				iid.order_no AS 'orderNo',
				temp.CUSTOMER_NAME AS 'customerName',
				temp.EMPLOYEE_NAME AS 'employeeName',
				'' AS 'responsiblePersonName',
				temp.MATERIAL_NAME AS 'materialName',
				'' AS 'commissionPeison',
				temp.LINE_NO AS 'lineNo',
				temp.ORGANIZE_NAME AS 'organize',
				iid.INVOICE_TYPE AS 'invoiceType',
				temp.NUM AS 'num',
				temp.UNIT_PRICE AS 'unitPrice',
				iid.invoice_amount AS 'invoiceAmount',
				iid.tax AS 'tax',
				iid.invoice_date AS 'invoiceDate',
				iid.invoice_no AS 'invoiceNo',
				ii.invoice_title AS 'invoiceTitle',
				ii.ticket_method AS 'ticketMethod',
				ii.recipients AS 'recipients',
				ii.rep_telephone AS 'repTelephone',
				ii.address AS 'address',
				iid.express_no AS 'expressNo',
				iid.express_company AS 'expressCompany'
		FROM IM_INVOICE_DTL iid
		INNER JOIN
		(SELECT
				rq.quotation_no AS ORDER_NO,
				rq.RESPONSIBLE_PERSON_ID AS EMPLOYEE_NO,
				su.NAME AS EMPLOYEE_NAME,
				rq.CUSTOMER_ID AS CUSTOMER_ID,
				cci.CUSTOMER_CH_NAME AS CUSTOMER_NAME,
				rqd.LINE_NO AS LINE_NO,
				rq.ORGANIZE AS ORGANIZE,
				sof.NAME AS ORGANIZE_NAME,
				rqd.MATERIAL_NO AS MATERIAL_NO,
				CONCAT(smi.MATERIAL_NAME,smi.MODEL) AS MATERIAL_NAME,
				rqd.NUM AS NUM,
				rqd.UNIT_PRICE AS UNIT_PRICE
		FROM RM_QUOTATION_DTL rqd
		INNER JOIN RM_QUOTATION rq ON rqd.REPAIR_NO = rq.REPAIR_NO AND rqd.quotation_no = rq.quotation_no AND rq.del_flag = '0'
		LEFT JOIN SYS_USER su ON su.ID = rq.RESPONSIBLE_PERSON_ID
		LEFT JOIN CM_CUSTOMER_INFO cci ON cci.CUSTOMER_ID = rq.CUSTOMER_ID
		LEFT JOIN SM_MAT_INFO smi ON smi.MATERIAL_NO = rqd.MATERIAL_NO
		LEFT JOIN SYS_OFFICE sof ON sof.ID = rq.ORGANIZE
		) temp
		ON iid.order_no = temp.order_no AND iid.LINE_NO = temp.LINE_NO
		INNER JOIN IM_INVOICE ii
		ON ii.id = iid.APP_ID AND ii.WORKFLOW_STATUS = '50' AND ii.del_flag = '0'
		<where>
			iid.invoice_source = '20'
			<if test="orderNo != null and orderNo != ''">
				AND iid.order_no like CONCAT(CONCAT('%', #{orderNo}), '%')
			</if>
			<if test="invoiceType != null and invoiceType != ''">
				AND iid.invoice_type = #{invoiceType}
			</if>
			<if test="invoiceNo != null and invoiceNo != ''">
				AND iid.invoice_no like CONCAT(CONCAT('%', #{invoiceNo}), '%')
			</if>
			<if test="invoiceTitle != null and invoiceTitle != ''">
				AND ii.invoice_title like CONCAT(CONCAT('%', #{invoiceTitle}), '%')
			</if>
			<if test="invoiceDateBegin != null and invoiceDateBegin != ''">
				AND iid.invoice_date >= #{invoiceDateBegin}
			</if>
			<if test="invoiceDateEnd != null and invoiceDateEnd != ''">
				AND #{invoiceDateEnd} >= iid.invoice_date
			</if>
			<if test="commissionPeison != null and commissionPeison != ''">
				AND temp.EMPLOYEE_NO = #{commissionPeison}
			</if>
			<if test="organize != null and organize != ''">
				AND temp.ORGANIZE = #{organize}
			</if>
			<if test="materialName != null and materialName != ''">
				AND temp.MATERIAL_NAME like CONCAT(CONCAT('%', #{materialName}), '%')
			</if>
			<if test="sqlMap != null and sqlMap.dataScope != null">
				AND temp.EMPLOYEE_NO in ${sqlMap.dataScope}
			</if>
		</where>
		)
		</if>
	</select> -->
	<select id="findAxPageList" resultType="ImInvoiceSearch">
		(SELECT
				temp.ORDER_NO AS 'orderNo',
				temp.PAYMAENT_CON AS 'paymaentCon',
				temp.ORDER_DATE AS 'orderDate',
				temp.EMPLOYEE_NAME AS 'employeeName',
				temp.CUSTOMER_NAME AS 'customerName',
				temp.AX_CUS_NO AS 'axCusNo',
				temp.ORGANIZE_NAME AS 'organize',
				temp.MATERIAL_NO AS 'materialNo',
				iid.NUM AS 'num',
				temp.UNIT_PRICE AS 'unitPrice'
		FROM IM_INVOICE_DTL iid
		INNER JOIN
		(SELECT
				so.ORDER_NO AS ORDER_NO,
				so.PAYMAENT_CON AS PAYMAENT_CON,
				so.ORDER_DATE AS ORDER_DATE,
				so.EMPLOYEE_NO AS EMPLOYEE_NO,
				su.NO AS EMPLOYEE_NAME,
				cci.CUSTOMER_CH_NAME AS CUSTOMER_NAME,
				cci.AX_CUS_NO AS AX_CUS_NO,
				sod.LINE_NO AS LINE_NO,
				sof.CODE AS ORGANIZE_NAME,
				sod.MATERIAL_NO AS MATERIAL_NO,
				sod.NUM AS NUM,
				sod.UNIT_PRICE AS UNIT_PRICE
		FROM SO_ORDER_DTL sod
		INNER JOIN SO_ORDER so ON sod.ORDER_ID = so.ID AND so.del_flag = '0'
		LEFT JOIN SYS_USER su ON su.ID = so.EMPLOYEE_NO
		LEFT JOIN CM_CUSTOMER_INFO cci ON cci.CUSTOMER_ID = so.CUSTOMER_ID
		LEFT JOIN SYS_OFFICE sof ON sof.ID = sod.ORGANIZE
		) temp
		ON iid.order_no = temp.order_no AND iid.LINE_NO = temp.LINE_NO
		INNER JOIN IM_INVOICE ii
		ON ii.id = iid.APP_ID AND ii.WORKFLOW_STATUS = '50' AND ii.del_flag = '0'
		<where>
			<if test="invoiceDateBegin != null and invoiceDateBegin != ''">
				AND iid.invoice_date >= #{invoiceDateBegin}
			</if>
			<if test="invoiceDateEnd != null and invoiceDateEnd != ''">
				AND #{invoiceDateEnd} >= iid.invoice_date
			</if>
			<if test="sqlMap != null and sqlMap.dataScope != null">
				AND temp.EMPLOYEE_NO in ${sqlMap.dataScope}
			</if>
		</where>
		)
		UNION ALL
		(SELECT
				temp.ORDER_NO AS 'orderNo',
				temp.PAYMAENT_CON AS 'paymaentCon',
				temp.ORDER_DATE AS 'orderDate',
				temp.EMPLOYEE_NAME AS 'employeeName',
				temp.CUSTOMER_NAME AS 'customerName',
				temp.AX_CUS_NO AS 'axCusNo',
				temp.ORGANIZE_NAME AS 'organize',
				temp.MATERIAL_NO AS 'materialNo',
				iid.NUM AS 'num',
				temp.UNIT_PRICE AS 'unitPrice'
		FROM IM_INVOICE_DTL iid
		INNER JOIN
		(SELECT
				rq.quotation_no AS ORDER_NO,
				'Other' AS PAYMAENT_CON,
				rq.QUOTE_DATE AS ORDER_DATE,
				rq.RESPONSIBLE_PERSON_ID AS EMPLOYEE_NO,
				su.NO AS EMPLOYEE_NAME,
				cci.CUSTOMER_CH_NAME AS CUSTOMER_NAME,
				cci.AX_CUS_NO AS AX_CUS_NO,
				rqd.LINE_NO AS LINE_NO,
				sysTemp.ORGANIZE_NAME AS ORGANIZE_NAME,
				rqd.MATERIAL_NO AS MATERIAL_NO,
				rqd.NUM AS NUM,
				rqd.UNIT_PRICE AS UNIT_PRICE
		FROM RM_QUOTATION_DTL rqd
		INNER JOIN RM_QUOTATION rq ON rqd.REPAIR_NO = rq.REPAIR_NO AND rqd.quotation_no = rq.quotation_no AND rq.del_flag = '0'
		LEFT JOIN SYS_USER su ON su.ID = rq.RESPONSIBLE_PERSON_ID
		LEFT JOIN CM_CUSTOMER_INFO cci ON cci.CUSTOMER_ID = rq.CUSTOMER_ID
		LEFT JOIN
		(SELECT
				su.ID AS RESPONSIBLE_PERSON_ID,
				su.OFFICE_ID AS OFFICE_ID,
				so.CODE AS ORGANIZE_NAME
		FROM sys_user su
		INNER JOIN sys_office so ON su.office_id = so.ID
		) sysTemp ON rq.RESPONSIBLE_PERSON_ID = sysTemp.RESPONSIBLE_PERSON_ID
		) temp
		ON iid.order_no = temp.order_no AND iid.LINE_NO = temp.LINE_NO
		INNER JOIN IM_INVOICE ii
		ON ii.id = iid.APP_ID AND ii.WORKFLOW_STATUS = '50' AND ii.del_flag = '0'
		<where>
			<if test="invoiceDateBegin != null and invoiceDateBegin != ''">
				AND iid.invoice_date >= #{invoiceDateBegin}
			</if>
			<if test="invoiceDateEnd != null and invoiceDateEnd != ''">
				AND #{invoiceDateEnd} >= iid.invoice_date
			</if>
			<if test="sqlMap != null and sqlMap.dataScope != null">
				AND temp.EMPLOYEE_NO in ${sqlMap.dataScope}
			</if>
		</where>
		)
	</select>
	
	<select id="getCommissionPeisonList" resultType="Dict" parameterType="java.lang.String">
		SELECT SU.NAME AS 'label', SU.ID AS 'value'
		FROM SO_ORDER_DTL SOD 
		INNER JOIN SYS_USER SU ON SU.ID=SOD.COMMISSION_PEISON_ID
		<if test="_parameter != null and _parameter != ''">
		AND SU.OFFICE_ID = #{organize}
		</if>
		GROUP BY SU.ID
	</select>
	
</mapper>
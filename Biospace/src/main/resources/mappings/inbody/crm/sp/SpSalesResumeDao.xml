<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.inbody.crm.sp.dao.SpSalesResumeDao">

    <!-- 根据指定的成交月查询销售履历数据 -->
    <select id="getSalesResumeExcelData" resultType="com.inbody.crm.sp.domain.SpSalesResume">
        SELECT 
            c.name AS "organize",
            d.name AS "saler",
            e.customer_ch_name AS "agent",
            f.customer_ch_name AS "endCustomer",
            CONCAT(g.material_name, " ", g.model) AS "model",
            b.num AS "num",
            b.unit_price AS "unitPrice",
            b.total_amount AS "totalAmount",
            a.exp_turnover AS "expTurnover",
            a.if_contract_generation AS "ifContractGeneration",
            h.workflow_status AS "orderStatus",
            h.invoice_status AS "invoiceStatus",
            a.new_remarks AS "newRemarks"
        FROM bo_business_opp a
        INNER JOIN bo_business_opp_dtl b
        LEFT JOIN sys_office c ON c.id = a.organize
        LEFT JOIN sys_user d ON d.id = a.responsible_person_id
        LEFT JOIN cm_customer_info e ON e.customer_id = a.agent_id
        LEFT JOIN cm_customer_info f ON f.customer_id = a.end_customer_id
        LEFT JOIN sm_mat_info g ON g.material_no = b.material_no
        LEFT JOIN so_order h ON h.business_opp_no = a.business_opp_no
        <where>
            a.if_sales_plan = '1'
            AND a.business_opp_no = b.business_opp_no
            AND DATE_FORMAT(a.exp_turnover_month, '%Y-%m') = DATE_FORMAT(#{expTurnoverMonth}, '%Y-%m')
            AND a.del_flag = '0'
            AND b.del_flag = '0'
        </where>
        ORDER BY b.business_opp_no DESC, b.line_no ASC
    </select>

</mapper>
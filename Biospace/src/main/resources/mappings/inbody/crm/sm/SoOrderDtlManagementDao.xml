<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.inbody.crm.sm.dao.SoOrderDtlManagementDao">
    

	<select id="selectByOrderId"  resultType="java.util.Map" parameterType="java.lang.String" >
		select
	 		s.id,
			s.ORDER_NO as orderNo,
			u.CUSTOMER_CH_NAME as name ,
			c.CUSTOMER_CH_NAME as customerChName,
			od.end_customer_id,
			s.MATERIAL_NO as materialNo,
			(select MATERIAL_NAME from sm_mat_info where MATERIAL_NO=s.MATERIAL_NO ORDER BY MATERIAL_NAME) AS materialName,
			(select MODEL from sm_mat_info where MATERIAL_NO=s.MATERIAL_NO) AS model,
			s.SN_NO as snNo,
			o.CUSTOMER_ID,
			s.PRODUCTION_DATE as productionDate,
			od.warranty_period as warrantyPeriod,
			od.extended_warr_period as extendedWarrPeriod,
			s.CREATE_DATE,
			od.commission_peison_id as commissionPeisonId,
			s.warranty_date_to as warrantyDateTo,
			s.warranty_date_from as warrantyDateFrom,
			(SELECT w.WAREHOUSE from sm_warehouse_info as w where w.SN_NO= s.SN_NO) as warehouse,
			s.LINE_NO as lineNo
		from sm_sn_info as s 
			INNER JOIN so_order as o on o.ORDER_NO=s.ORDER_NO 
			INNER JOIN so_order_dtl as od on od.ORDER_ID = o.ID and od.LINE_NO=s.LINE_NO 
			LEFT JOIN cm_customer_info as c ON c.customer_id = od.end_customer_id
			LEFT JOIN cm_customer_info as u on u.customer_id = o.CUSTOMER_ID
		where s.DEL_FLAG ='0'and s.ORDER_NO = #{_parameter}
			AND NOT EXISTS (
			SELECT
				ssad.ORDER_NO AS ORDER_NO,
				ssad.LINE_NO AS LINE_NO,
				ssad.MATERIAL_NO AS MATERIAL_NO,
				ssad.SN_NO AS SN_NO
			FROM SM_STORAGE_APP_DTL ssad
			INNER JOIN SM_STORAGE_APP ssa ON ssa.id = ssad.app_id
				AND ssa.DEL_FLAG = '0'
				AND ssa.WORKFLOW_STATUS != '50'
				AND ssa.STORAGE_TYPE = '25'
			WHERE ssad.ORDER_NO = s.ORDER_NO
				AND ssad.LINE_NO = s.LINE_NO
				AND ssad.MATERIAL_NO = s.MATERIAL_NO
				AND ssad.SN_NO = s.SN_NO)
	</select>
	
	<select id="smStorageAppDtl"  resultType="java.util.Map">
		select
			sa.id,
			s.id as sId,
			s.ORDER_NO as orderNo,
			u.CUSTOMER_CH_NAME as name ,
			c.customer_ch_name as customerChName,
			s.MATERIAL_NO as materialNo,
			(select MATERIAL_NAME from sm_mat_info where MATERIAL_NO=s.MATERIAL_NO ORDER BY MATERIAL_NAME) AS materialName,
			(select MODEL from sm_mat_info where MATERIAL_NO=s.MATERIAL_NO) AS model,
			s.SN_NO as snNo,
			s.PRODUCTION_DATE as productionDate,
			od.warranty_period as warrantyPeriod,
			od.extended_warr_period as extendedWarrPeriod,
			s.CREATE_DATE,
			od.commission_peison_id as commissionPeisonId,
			s.warranty_date_to as warrantyDateTo,
			s.warranty_date_from as warrantyDateFrom,
			sa.NEW_SN_NO,
			(SELECT production_date from sm_sn_info where SN_NO=sa.NEW_SN_NO) as newProductionDate,
			sa.LENDING_DATE_TO
		from sm_storage_app_dtl as sa
			inner JOIN  so_order as o on o.ORDER_NO=sa.ORDER_NO 
			inner JOIN  so_order_dtl as od on od.ORDER_ID = o.ID and od.LINE_NO=sa.LINE_NO 
			inner JOIN  sm_sn_info as s on s.SN_NO= sa.SN_NO 
			left JOIN  cm_customer_info as c ON c.customer_id = od.end_customer_id
			left JOIN cm_customer_info as u on u.customer_id = o.CUSTOMER_ID
		where s.DEL_FLAG ='0'  and sa.APP_ID =  #{id}
	</select>
	
</mapper>
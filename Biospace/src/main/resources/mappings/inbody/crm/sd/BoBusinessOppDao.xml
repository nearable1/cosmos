<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.inbody.crm.sd.dao.BoBusinessOppDao">
    
    <sql id="boBusinessOppDtlColumns">
		b.line_no AS "lineNo",
		b.material_no AS "materialNo",
		m.model AS "model",
		b.num AS "num",
		b.unit_price AS "unitPrice",
		b.total_amount AS "totalAmount",
		b.standard_price AS "standardPrice",
		b.if_special_offer AS "ifSpecialOffer",
	</sql>
	<sql id="boBusinessOppOtherColumns">
		c1.customer_ch_name as "endCustomerName",
		c2.customer_ch_name as "agentName",
		c1.industry AS "industry",
		c1.region AS "area",
		u.name AS "responsiblePersonName",
		o.name AS "organizeName",
	</sql>
	
	<sql id="boBusinessOppColumns">
	    a.id AS "id",
		a.proc_ins_id AS "procInsId",
		a.create_by AS "createBy.id",
		a.create_date AS "createDate",
		a.update_by AS "updateBy.id",
		a.update_date AS "updateDate",
		a.del_flag AS "delFlag",
		a.business_opp_no AS "businessOppNo",
		a.price_system AS "priceSystem",
		a.customer_source AS "customerSource",
		a.responsible_person_id AS "responsiblePersonId",
		a.organize as "organize",
		a.exp_turnover AS "expTurnover",
		a.exp_turnover_month AS "expTurnoverMonth",
		IFNULL(a.if_sales_plan,0) AS "ifSalesPlan",
		IFNULL(a.if_tender_author,0) AS "ifTenderAuthor",
		IFNULL(a.if_contract_generation,0) AS "ifContractGeneration",
		a.agent_id AS "agentId",
		a.end_customer_id AS "endCustomerId",
		a.customer_segmentation AS "customerSegmentation",
		a.contacts_name AS "contactsName",
		a.position AS "position",
		a.telephone AS "telephone",
		a.email AS "email",
		a.address AS "address",
		a.agent_contacts_name AS "agentContactsName",
		a.agent_position AS "agentPosition",
		a.agent_telephone AS "agentTelephone",
		a.agent_email AS "agentEmail",
		a.agent_address AS "agentAddress",
		a.new_remarks AS "newRemarks",
		IFNULL(a.if_fail,0) AS "ifFail",
		a.fail_remarks AS "failRemarks"
	</sql>
	
	<sql id="boBusinessOppDetailJoins">
	    inner join bo_business_opp_dtl b
	    on a.business_opp_no = b.business_opp_no
		and b.del_flag = 0
	    inner join sm_mat_info m
	    on b.material_no = m.material_no
	</sql>
	<sql id="boBusinessOppJoins">
	    left join cm_customer_info c1
	    on a.end_customer_id = c1.customer_id
	    left join cm_customer_info c2
	    on a.agent_id = c2.customer_id
	    and c2.customer_type != 1
	    left join sys_user u
	    on u.id = a.responsible_person_id
	    left join sys_office o
	    on o.id = a.organize
	</sql>
    
	<select id="get" resultType="BoBusinessOpp">
		SELECT 
		    <include refid="boBusinessOppOtherColumns"/>
			<include refid="boBusinessOppColumns"/>
		FROM bo_business_opp a
		<include refid="boBusinessOppJoins"/>
		WHERE a.id = #{id}
	</select>
	
	<select id="findListByCustomerId" resultType="BoBusinessOpp">
		SELECT 
	   		<include refid="boBusinessOppColumns"/>
		FROM bo_business_opp a
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
			<if test="endCustomerId != null and endCustomerId != ''">
				AND a.end_customer_id = #{endCustomerId}
				or a.agent_id = #{endCustomerId}
			</if>
		</where>
	</select>
	
	<select id="getInfoByBusinessOppNo" resultType="BoBusinessOpp">
		SELECT 
	   		<include refid="boBusinessOppOtherColumns"/>
			<include refid="boBusinessOppColumns"/>
		FROM bo_business_opp a
		<include refid="boBusinessOppJoins"/>
		<where>
			a.del_flag = 0
			AND a.business_opp_no = #{businessOppNo}
		</where>
	</select>
	
	<select id="findList" resultType="BoBusinessOpp">
		SELECT 
		    <include refid="boBusinessOppOtherColumns"/>
			<include refid="boBusinessOppDtlColumns"/>
			<include refid="boBusinessOppColumns"/>
		FROM bo_business_opp a
		<include refid="boBusinessOppDetailJoins"/>
		<include refid="boBusinessOppJoins"/>
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
			<if test="expTurnoverMonth != null and expTurnoverMonth != ''">
				AND a.exp_turnover_month = #{expTurnoverMonth}
			</if>
			<if test="responsiblePersonId != null and responsiblePersonId != ''">
				AND a.responsible_person_id = #{responsiblePersonId}
			</if>
			<if test="organize != null and organize != ''">
				AND a.organize = #{organize}
			</if>
			<if test="endCustomerId != null and endCustomerId != ''">
				AND a.end_customer_id = #{endCustomerId}
			</if>
			<if test="endCustomerName != null and endCustomerName != ''">
				AND c1.customer_ch_name like CONCAT(CONCAT('%',#{endCustomerName}),'%') 
			</if>
			<if test="agentId != null and agentId != ''">
				AND a.agent_id = #{agentId}
			</if>
			<if test="agentName != null and agentName != ''">
				AND c2.customer_ch_name like CONCAT(CONCAT('%',#{agentName}),'%')
			</if>
			<if test="ifSalesPlan != null and ifSalesPlan != ''">
				AND a.if_sales_plan = #{ifSalesPlan}
			</if>
			<if test="ifTenderAuthor != null and ifTenderAuthor != ''">
				AND a.if_tender_author = #{ifTenderAuthor}
			</if>
			<if test="ifContractGeneration != null and ifContractGeneration != ''">
				AND a.if_contract_generation = #{ifContractGeneration}
			</if>
			<if test="ifFail != null and ifFail != ''">
				AND a.if_fail = #{ifFail}
			</if>
			<if test="sqlMap != null and sqlMap.dataScope != null">
			    AND a.responsible_person_id in ${sqlMap.dataScope}
		    </if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.business_opp_no DESC,b.line_no
			</otherwise>
		</choose>
	</select>
	
	<select id="findListByCustomer" resultType="BoBusinessOpp">
		select a.* from 
		(
		(select bd.business_opp_no, bd.material_no,m.model,bd.line_no,bd.num,bo.end_customer_id,bo.del_flag
		from bo_business_opp bo
		inner join bo_business_opp_dtl bd
		on bo.business_opp_no = bd.business_opp_no
		and bd.del_flag = #{DEL_FLAG_NORMAL}
		inner join sm_mat_info m
		on bd.material_no = m.material_no)a
		inner join
		(
		select business_opp_no,min(line_no)line_no from bo_business_opp_dtl
		group by business_opp_no)b
		
		on a.business_opp_no = b.business_opp_no
		and a.line_no = b.line_no
		)
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
			<if test="endCustomerId != null and endCustomerId != ''">
				AND a.end_customer_id = #{endCustomerId}
			</if>
		</where>
		order by a.business_opp_no
	</select>
	
	<select id="findAllList" resultType="BoBusinessOpp">
		SELECT 
			<include refid="boBusinessOppOtherColumns"/>
			<include refid="boBusinessOppDtlColumns"/>
			<include refid="boBusinessOppColumns"/>
		FROM bo_business_opp a
		<include refid="boBusinessOppDetailJoins"/>
		<include refid="boBusinessOppJoins"/>
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
		</where>		
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.business_opp_no DESC,b.line_no
			</otherwise>
		</choose>
	</select>
	
	<insert id="insert">
		INSERT INTO bo_business_opp(
			id,
			proc_ins_id,
			create_by,
			create_date,
			update_by,
			update_date,
			del_flag,
			business_opp_no,
			price_system,
			customer_source,
			responsible_person_id,
		    organize,
			exp_turnover,
			exp_turnover_month,
			if_sales_plan,
			if_tender_author,
			if_contract_generation,
			agent_id,
			end_customer_id,
			customer_segmentation,
			contacts_name,
			position,
			telephone,
			email,
			address,
			agent_contacts_name,
			agent_position,
			agent_telephone,
			agent_email,
			agent_address,
			new_remarks,
			if_fail,
			fail_remarks
		) VALUES (
			#{id},
			#{procInsId},
			#{createBy.id},
			#{createDate},
			#{updateBy.id},
			#{updateDate},
			#{delFlag},
			#{businessOppNo},
			#{priceSystem},
			#{customerSource},
			#{responsiblePersonId},
		    #{organize},
			#{expTurnover},
			#{expTurnoverMonth},
			#{ifSalesPlan},
			#{ifTenderAuthor},
			#{ifContractGeneration},
			#{agentId},
			#{endCustomerId},
			#{customerSegmentation},
			#{contactsName},
			#{position},
			#{telephone},
			#{email},
			#{address},
			#{agentContactsName},
			#{agentPosition},
			#{agentTelephone},
			#{agentEmail},
			#{agentAddress},
			#{newRemarks},
			#{ifFail},
			#{failRemarks}
		)
	</insert>
	
	<update id="update">
		UPDATE bo_business_opp SET 	
			update_by = #{updateBy.id},
			update_date = #{updateDate},
			price_system = #{priceSystem},
			customer_source = #{customerSource},
			responsible_person_id = #{responsiblePersonId},
		    organize = #{organize},
			exp_turnover = #{expTurnover},
			exp_turnover_month = #{expTurnoverMonth},
			if_sales_plan = #{ifSalesPlan},
			if_tender_author = #{ifTenderAuthor},
			if_contract_generation = #{ifContractGeneration},
			agent_id = #{agentId},
			end_customer_id = #{endCustomerId},
			customer_segmentation = #{customerSegmentation},
			contacts_name = #{contactsName},
			position = #{position},
			telephone = #{telephone},
			email = #{email},
			address = #{address},
			agent_contacts_name = #{agentContactsName},
			agent_position = #{agentPosition},
			agent_telephone = #{agentTelephone},
			agent_email = #{agentEmail},
			agent_address = #{agentAddress},
			new_remarks = #{newRemarks},
			if_fail = #{ifFail},
			fail_remarks = #{failRemarks}
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		UPDATE bo_business_opp SET 
			del_flag = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>
	
	<update id="updateSalesPlan">
		UPDATE bo_business_opp SET 
			if_sales_plan = #{ifSalesPlan}
		WHERE business_opp_no = #{businessOppNo}
	</update>
	
</mapper>
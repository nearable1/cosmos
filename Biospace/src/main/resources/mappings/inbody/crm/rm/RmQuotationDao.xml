<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.inbody.crm.rm.dao.RmQuotationDao">
    
	<sql id="rmQuotationColumns">
		a.id AS "id",
		a.proc_ins_id AS "procInsId",
		a.create_by AS "createBy.id",
		a.create_date AS "createDate",
		a.update_by AS "updateBy.id",
		a.update_date AS "updateDate",
		a.del_flag AS "delFlag",
		a.quotation_no AS "quotationNo",
		a.quotation_type AS "quotationType",
		a.repair_no AS "repairNo",
		a.responsible_person_id AS "responsiblePersonId",
		a.organize AS "organize",
		a.customer_id AS "customerId",
		a.quote_date AS "quoteDate",
		a.contacts_name AS "contactsName",
		a.telephone AS "telephone",
		a.address AS "address",
		a.receive_status AS "receiveStatus",
		a.act_date_from AS "actDateFrom",
		a.invoice_title AS "invoiceTitle",
		a.new_remarks AS "newRemarks",
		a.invoice_status AS "invoiceStatus",
		a.if_occupy AS "ifOccupy",
		a.deposit_rate AS "depositRate",
		a.if_out AS "ifOut"
	</sql>
	
	<sql id="rmQuotationJoins">
	</sql>
    
	<select id="get" resultType="com.inbody.crm.rm.entity.RmQuotation">
		SELECT 
			<include refid="rmQuotationColumns"/>
		FROM rm_quotation a
		<include refid="rmQuotationJoins"/>
		WHERE a.id = #{id}
	</select>
	
	<select id="findList" resultType="com.inbody.crm.rm.entity.RmQuotation">
		SELECT 
			<include refid="rmQuotationColumns"/>
		FROM rm_quotation a
		<include refid="rmQuotationJoins"/>
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.update_date DESC
			</otherwise>
		</choose>
	</select>
	
	<select id="findAllList" resultType="com.inbody.crm.rm.entity.RmQuotation">
		SELECT 
			<include refid="rmQuotationColumns"/>
		FROM rm_quotation a
		<include refid="rmQuotationJoins"/>
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
		</where>		
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.update_date DESC
			</otherwise>
		</choose>
	</select>
	
	<insert id="insert">
		INSERT INTO rm_quotation(
			id,
			proc_ins_id,
			create_by,
			create_date,
			update_by,
			update_date,
			del_flag,
			quotation_no,
			quotation_type,
			repair_no,
			responsible_person_id,
			organize,
			customer_id,
			quote_date,
			contacts_name,
			telephone,
			address,
			receive_status,
			act_date_from,
			invoice_title,
			new_remarks,
			invoice_status,
			deposit_rate,
			if_occupy,
			if_out
		) VALUES (
			#{id},
			#{procInsId},
			#{createBy.id},
			#{createDate},
			#{updateBy.id},
			#{updateDate},
			#{delFlag},
			#{quotationNo},
			#{quotationType},
			#{repairNo},
			#{responsiblePersonId},
			#{organize},
			#{customerId},
			#{quoteDate},
			#{contactsName},
			#{telephone},
			#{address},
			#{receiveStatus},
			#{actDateFrom},
			#{invoiceTitle},
			#{newRemarks},
			#{invoiceStatus},
			#{depositRate},
			#{ifOccupy},
			#{ifOut}
		)
	</insert>
	
	<update id="update">
		UPDATE rm_quotation SET 	
			proc_ins_id = #{procInsId},
			update_by = #{updateBy.id},
			update_date = #{updateDate},
			quotation_no = #{quotationNo},
			quotation_type = #{quotationType},
			repair_no = #{repairNo},
			responsible_person_id = #{responsiblePersonId},
			organize = #{organize},
			customer_id = #{customerId},
			quote_date = #{quoteDate},
			contacts_name = #{contactsName},
			telephone = #{telephone},
			address = #{address},
			receive_status = #{receiveStatus},
			act_date_from = #{actDateFrom},
			invoice_title = #{invoiceTitle},
			new_remarks = #{newRemarks},
			invoice_status = #{invoiceStatus},
			deposit_rate =  #{depositRate},
			if_occupy = #{ifOccupy},
			if_out = #{ifOut}
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		UPDATE rm_quotation SET 
			del_flag = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>

    <!-- 根据报价单id取得报价单信息 -->
    <select id="getQuotaById" resultType="com.inbody.crm.rm.entity.RmQuotation">
        SELECT 
            <include refid="rmQuotationColumns"/>,
			su.name AS "responsiblePersonName",
			cci.customer_ch_name AS "customerName",
            b.sn_no AS "snNo",
            b.repair_type AS "repairType"
        FROM rm_quotation a
		LEFT JOIN sys_user su ON a.responsible_person_id = su.id
		LEFT JOIN cm_customer_info cci ON a.customer_id = cci.customer_id
        INNER JOIN rm_repair_info b on b.repair_no = a.repair_no
        <include refid="rmQuotationJoins"/>
        WHERE a.id = #{id}
        AND a.del_flag = '0'
        AND b.del_flag = '0'
    </select>

    <!-- 报价单配件标准价格取得 -->
    <select id="getAccStandardPrice" resultType="java.math.BigDecimal">
        SELECT
            a.unit_price AS "unitPrice"
        FROM ps_price_info a 
        <where>
            a.del_flag = '0'
            AND a.price_system = '6'
            AND a.material_no = #{materialNo}
        </where>
    </select>

    <!-- 根据维修编号取得预报价单id -->
    <select id="getPreQuotaIdByRepairNo" resultType="java.lang.String">
        SELECT 
            a.id
        FROM rm_quotation a
        WHERE a.repair_no = #{repairNo}
        AND a.quotation_type = '1'
        AND a.del_flag = '0'
    </select>

    <!-- 根据维修编号取得预报价单对应的sn号 -->
    <select id="getQuotaSnByRepairNo" resultType="java.lang.String">
        SELECT 
            a.sn_no
        FROM rm_repair_info a
        WHERE a.repair_no = #{repairNo}
        AND a.del_flag = '0'
    </select>

    <!-- 根据维修编号取得预报价单对应的sn号信号 -->
    <select id="getQuotaSnModelByRepairNo" resultType="java.lang.String">
        SELECT 
            smi.MODEL
        FROM rm_repair_info a
        INNER JOIN sm_sn_info ssi ON TRIM(IFNULL(a.SN_NO, '')) = TRIM(IFNULL(ssi.SN_NO, ''))
		INNER JOIN sm_mat_info smi ON ssi.MATERIAL_NO = smi.MATERIAL_NO
        WHERE a.repair_no = #{repairNo}
        AND a.del_flag = '0'
    </select>

    <!-- 获取报价单开票客户信息 -->
    <select id="getCustomerInfo" resultType="com.inbody.crm.rm.entity.CmCustomerInfo">
        SELECT 
            a.industry AS "industry",
            a.customer_diff AS "customerDiff",
            a.customer_ch_name AS "customerChName",
            a.province AS "province",
            a.city AS "city",
            a.invoice_type AS "invoiceType",
            a.invoice_title AS "invoiceTitle",
            a.taxpayer_ident_no AS "taxpayerIdentNo",
            a.deposit_bank AS "depositBank",
            a.bank_account AS "bankAccount",
            a.invoice_address AS "invoiceAddress",
            a.telephone AS "telephone",
            a.region AS "region",
            b.name AS "provinceName",
            c.name AS "cityName"
        FROM cm_customer_info a
        LEFT JOIN sys_area b ON b.code = a.province
        LEFT JOIN sys_area c ON c.code = a.city
        WHERE a.customer_id = #{customerId}
        AND a.del_flag = '0'
    </select>

    <!-- 取得报价单明细sn对应的生产日期 -->
    <select id="getSnProductionDate" resultType="java.util.Date">
        SELECT 
            a.production_date AS "productionDate"
        FROM sm_sn_info a
        WHERE a.sn_no = #{snNo}
        AND a.del_flag = '0'
    </select>
</mapper>
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.inbody.crm.rm.dao.RmConsultingInfoDao">
    
	<sql id="rmConsultingInfoColumns">
		a.id AS "id",
		a.proc_ins_id AS "procInsId",
		a.create_by AS "createBy.id",
		a.create_date AS "createDate",
		a.update_by AS "updateBy.id",
		a.update_date AS "updateDate",
		a.del_flag AS "delFlag",
		a.consulting_no AS "consultingNo",
		a.consulting_type AS "consultingType",
		a.material_no AS "materialNo",
		a.responsible_person_id AS "responsiblePersonId",
		a.consulting_date AS "consultingDate",
		a.consulting_status AS "consultingStatus",
		a.customer_name AS "customerName",
		a.contacts_name AS "contactsName",
		a.telephone AS "telephone",
		a.new_remarks AS "newRemarks"
	</sql>
	
	<sql id="rmConsultingInfoJoins">
	</sql>
    
	<select id="get" resultType="RmConsultingInfo">
		SELECT 
			<include refid="rmConsultingInfoColumns"/>
		FROM rm_consulting_info a
		<include refid="rmConsultingInfoJoins"/>
		WHERE a.id = #{id}
	</select>
	
	<select id="findList" resultType="RmConsultingInfo">
		SELECT 
			<include refid="rmConsultingInfoColumns"/>
		FROM rm_consulting_info a
		<include refid="rmConsultingInfoJoins"/>
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.update_date DESC
			</otherwise>
		</choose>
	</select>
	
	<select id="findAllList" resultType="RmConsultingInfo">
		SELECT 
			<include refid="rmConsultingInfoColumns"/>
		FROM rm_consulting_info a
		<include refid="rmConsultingInfoJoins"/>
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
		</where>		
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.update_date DESC
			</otherwise>
		</choose>
	</select>
	
	<insert id="insert">
		INSERT INTO rm_consulting_info(
			id,
			proc_ins_id,
			create_by,
			create_date,
			update_by,
			update_date,
			del_flag,
			consulting_no,
			consulting_type,
			material_no,
			responsible_person_id,
			consulting_date,
			consulting_status,
			customer_name,
			contacts_name,
			telephone,
			new_remarks
		) VALUES (
			#{id},
			#{procInsId},
			#{createBy.id},
			#{createDate},
			#{updateBy.id},
			#{updateDate},
			#{delFlag},
			#{consultingNo},
			#{consultingType},
			#{materialNo},
			#{responsiblePersonId},
			#{consultingDate},
			#{consultingStatus},
			#{customerName},
			#{contactsName},
			#{telephone},
			#{newRemarks}
		)
	</insert>
	
	<update id="update">
		UPDATE rm_consulting_info SET 	
			proc_ins_id = #{procInsId},
			update_by = #{updateBy.id},
			update_date = #{updateDate},
			consulting_no = #{consultingNo},
			consulting_type = #{consultingType},
			material_no = #{materialNo},
			responsible_person_id = #{responsiblePersonId},
			consulting_date = #{consultingDate},
			consulting_status = #{consultingStatus},
			customer_name = #{customerName},
			contacts_name = #{contactsName},
			telephone = #{telephone},
			new_remarks = #{newRemarks}
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		UPDATE rm_consulting_info SET 
			del_flag = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>
	
	<!-- 无sn咨询一览查询 -->
	<select id="findListBySelective" resultType="RmConsultingSearch">
		SELECT 
			<include refid="rmConsultingInfoColumns"/>,
			CONCAT(b.material_name, " ", b.model) AS "materialName",
			cre.name AS "responsiblePersonName",
			c.name AS "createBy.name"
		FROM rm_consulting_info a
		LEFT JOIN sm_mat_info b ON b.material_no = a.material_no
		LEFT JOIN sys_user c ON c.id = a.create_by
		LEFT JOIN sys_user cre ON cre.id = a.responsible_person_id
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
			<if test="consultingType != null and consultingType != ''">
				AND a.consulting_type = #{consultingType}
			</if>
			<if test="materialNo != null and materialNo != ''">
				AND a.material_no = #{materialNo}
			</if>
			<if test="responsiblePersonId != null and responsiblePersonId != ''">
				AND a.responsible_person_id = #{responsiblePersonId}
			</if>
			<if test="consultingStatus != null and consultingStatus != ''">
				AND a.consulting_status = #{consultingStatus}
			</if>
			<if test="consultingDateFrom != null and consultingDateFrom != ''">
				AND a.consulting_date &gt;= #{consultingDateFrom}
			</if>
			<if test="consultingDateTo != null and consultingDateTo != ''">
				AND a.consulting_date &lt;= #{consultingDateTo}
			</if>
			<if test="customerName != null and customerName != ''">
				AND a.customer_name like CONCAT(CONCAT('%', #{customerName}), '%')
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.consulting_no DESC
			</otherwise>
		</choose>
	</select>
	
</mapper>
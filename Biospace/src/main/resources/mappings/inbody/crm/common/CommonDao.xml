<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.inbody.crm.common.persistence.CommonDao">
	<select id="getNextSequence" parameterType="java.util.Map" resultType="int" statementType="CALLABLE">
        select get_next_sequence(#{sequence_code},#{key_code}) from dual
    </select>

    <!-- 物料分页模糊查询 -->
    <select id="getMaterialDictList" resultType="com.inbody.crm.common.entity.SelectEntity">
        SELECT
            a.material_no AS "id",
            CONCAT(a.material_name, " ", a.model) AS "text",
            CONCAT(a.material_name, " ", a.model) AS "label",
            a.model AS "model"
        FROM sm_mat_info a
        WHERE (a.material_no LIKE CONCAT('%', #{key}, '%')
        OR a.material_name LIKE CONCAT('%', #{key}, '%')
        OR a.model LIKE CONCAT('%', #{key}, '%'))
        <if test="type != null and type != ''">
        AND a.material_type IN (${type})
        </if>
        AND a.del_flag = '0'
        ORDER BY ABS(CHAR_LENGTH(CONCAT(a.material_no, a.material_name, a.model)) - CHAR_LENGTH("${key}"))
    </select>

	<select id="getMaterialByNo" resultType="com.inbody.crm.common.entity.SelectEntity">
		SELECT
		    a.material_no AS "id",
		    CONCAT(a.material_name, " ", a.model) AS "text",
		    CONCAT(a.material_name, " ", a.model) AS "label",
		    a.model AS "model"
		FROM sm_mat_info a
		WHERE a.material_no = #{materialNo}
	</select>
	
	<select id="getSmPackageInfoByMaterialNo" resultType="com.inbody.crm.common.entity.SmPackageInfoEntity">
		SELECT
		    a.material_no AS "materialNo",
		    a.material_name AS "materialName",
		    a.model AS "model",
		    a.material_type AS "materialType",
		    spi.num AS "num"
		FROM sm_mat_info a
		INNER JOIN SM_PACKAGE_INFO spi ON spi.child_material_no =  a.material_no
		WHERE spi.material_no = #{materialNo}
		AND a.del_flag = '0'
		AND spi.del_flag = '0'
		ORDER BY a.material_type ASC
	</select>

	<select id="getCustomerDictList" resultType="com.inbody.crm.common.entity.SelectEntity">
		SELECT
		    a.customer_id AS "id",
		    a.customer_ch_name AS "text",
		    a.customer_ch_name AS "label"
		FROM CM_CUSTOMER_INFO a
		WHERE (a.customer_id LIKE CONCAT(CONCAT('%', #{key}), '%')
		OR a.customer_ch_name LIKE CONCAT(CONCAT('%', #{key}), '%')
		OR a.customer_parent_co LIKE CONCAT(CONCAT('%', #{key}), '%')
		OR a.ax_cus_no LIKE CONCAT(CONCAT('%', #{key}), '%'))
		<if test="type != null and type != ''">
		AND a.customer_type IN (${type})
		</if>
		AND a.del_flag = '0'
		LIMIT 10
	</select>
	
	<select id="getCustomerById" resultType="com.inbody.crm.common.entity.SelectEntity">
		SELECT
		    a.customer_id AS "id",
		    a.customer_ch_name AS "text",
		    a.customer_ch_name AS "label"
		FROM CM_CUSTOMER_INFO a
		WHERE a.customer_id = #{customersId}
		AND a.del_flag = '0'
	</select>

	<select id="getEmployeeDictList" resultType="com.inbody.crm.common.entity.SelectEntity">
		SELECT
		    a.id AS "id",
		    a.name AS "text",
		    a.name AS "label"
		FROM SYS_USER a
		WHERE (a.no LIKE CONCAT(CONCAT('%', #{key}), '%')
		OR a.name LIKE CONCAT(CONCAT('%', #{key}), '%')
		OR a.login_name LIKE CONCAT(CONCAT('%', #{key}), '%'))
		<if test="type != null and type != ''">
		AND a.user_type IN (${type})
		</if>
		AND a.del_flag = '0'
		<if test="sqlMap != null and sqlMap.dataScope != null">
			AND a.id in ${sqlMap.dataScope}
		</if>
		LIMIT 10
	</select>
	
	<select id="getEmployeeInfoById" resultType="com.inbody.crm.common.entity.SelectEntity">
		SELECT
		    a.id AS "id",
		    a.name AS "text",
		    a.name AS "label"
		FROM SYS_USER a
		WHERE a.id = #{id}
	</select>

	<select id="getOrganize" resultType="java.lang.String">
		SELECT 
			a.office_id
		FROM sys_user a
		INNER JOIN sys_office syso ON a.office_id = syso.id AND a.id = #{employeeId} AND a.del_flag = '0'
	</select>
    
	<select id="getStandardPrice1" resultType="java.lang.String">
		SELECT 
			a.unit_price
		FROM PS_PRICE_INFO a
		WHERE a.del_flag = '0'
			AND a.price_system = #{priceSystem}
		<if test="materialNo != null and materialNo != ''">
			AND a.material_no = #{materialNo}
		</if>
		<if test="customerId != null and customerId != ''">
			AND a.agreement_paties_id = #{customerId}
		</if>
		<if test="customerId == null or customerId == ''">
			AND LENGTH(TRIM(IFNULL(a.agreement_paties_id, ''))) = 0
		</if>
		<if test="region != null and region != ''">
			AND a.region = #{region}
		</if>
		<if test="region == null or region == ''">
			AND LENGTH(TRIM(IFNULL(a.region, ''))) = 0
		</if>
		<if test="industry != null and industry != ''">
			AND a.industry = #{industry}
		</if>
		<if test="industry == null or industry == ''">
			AND LENGTH(TRIM(IFNULL(a.industry, ''))) = 0
		</if>
		ORDER BY a.update_date DESC limit 1
	</select>
    
	<select id="getStandardPrice24" resultType="java.lang.String">
		SELECT 
			a.unit_price
		FROM PS_PRICE_INFO a
		WHERE a.del_flag = '0'
			AND a.price_system = #{priceSystem}
		<if test="materialNo != null and materialNo != ''">
			AND a.material_no = #{materialNo}
		</if>
		<if test="region != null and region != ''">
			AND a.region = #{region}
		</if>
		<if test="region == null or region == ''">
			AND LENGTH(TRIM(IFNULL(a.region, ''))) = 0
		</if>
		<if test="industry != null and industry != ''">
			AND a.industry = #{industry}
		</if>
		<if test="industry == null or industry == ''">
			AND LENGTH(TRIM(IFNULL(a.industry, ''))) = 0
		</if>
		ORDER BY a.update_date DESC limit 1
	</select>
    
	<select id="getStandardPrice3" resultType="java.lang.String">
		SELECT 
			a.unit_price
		FROM PS_PRICE_INFO a
		WHERE a.del_flag = '0'
			AND a.price_system = #{priceSystem}
		<if test="materialNo != null and materialNo != ''">
			AND a.material_no = #{materialNo}
		</if>
		<if test="customerId != null and customerId != ''">
			AND a.agreement_paties_id = #{customerId}
		</if>
		<if test="customerId == null or customerId == ''">
			AND LENGTH(TRIM(IFNULL(a.agreement_paties_id, ''))) = 0
		</if>
		ORDER BY a.update_date DESC limit 1
	</select>
    
	<select id="getStandardPrice5" resultType="java.lang.String">
		SELECT 
			a.unit_price
		FROM PS_PRICE_INFO a
		WHERE a.del_flag = '0'
			AND a.price_system = #{priceSystem}
		<if test="materialNo != null and materialNo != ''">
			AND a.material_no = #{materialNo}
		</if>
		<if test="region != null and region != ''">
			AND a.region = #{region}
		</if>
		<if test="region == null or region == ''">
			AND LENGTH(TRIM(IFNULL(a.region, ''))) = 0
		</if>
		<if test="industry != null and industry != ''">
			AND a.industry = #{industry}
		</if>
		<if test="industry == null or industry == ''">
			AND LENGTH(TRIM(IFNULL(a.industry, ''))) = 0
		</if>
		ORDER BY a.update_date DESC limit 1
	</select>
	
	<select id="getCustomerParentCo" resultType="java.lang.String">
		SELECT
		    a.customer_parent_co
		FROM CM_CUSTOMER_INFO a
		WHERE a.customer_id = #{customersId}
		AND a.del_flag = '0'
	</select>
	
	<select id="getUserByRoles" resultType="java.lang.String">
		SELECT
			a.id
		FROM sys_user a
		JOIN sys_user_role ur ON a.id = ur.user_id
		JOIN sys_role r ON r.id = ur.role_id AND r.enname IN (${enNames})
		WHERE a.del_flag = '0'
			AND a.id = #{id}
	</select>
</mapper>